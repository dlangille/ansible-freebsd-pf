---
# handlers for freebsd-pf

# sshguard -----------------------------------------------------------
- name: enable and start sshguard
  service: name="sshguard" state="started" enabled="yes"

- name: disable and stop sshguard
  service: name="sshguard" state="stopped" enabled="no"

- name: restart sshguard
  service: name="sshguard" state="restarted"

#  /usr/local/etc/rc.d/sshguard: unknown directive 'reload'.
#- name: reload sshguard
#  service: name="sshguard" state="reloaded"

# pflog --------------------------------------------------------------
- name: enable and start pflog
  service:
    name: "pflog"
    state: started
    enabled: yes

- name: disable and stop pflog
  service:
    name: "pflog"
    state: stopped
    enabled: no

- name: restart pflog
  service:
    name: "pflog"
    state: restarted
      
- name: reload pflog
  service:
    name: "pflog"
    state: reloaded

# pf -----------------------------------------------------------------
# start, restart, reload of pf break the ssh connection. Sleep for 5
# seconds and let the async/poll to close the connection correctly
# before restarting pf. Shell module must be used instead of
# service.

- name: start pf
# service: name="pf" state="started" enabled="yes"
  shell: (( sleep 5; nohup service pf start 1>/dev/null 2>&1 ) & )
  async: 1
  poll: 0
  when: not ansible_check_mode
  changed_when: true

- name: disable and stop pf
  service:
    name: "pf"
    state: stopped
    enabled: no

- name: restart pf
# service: name="pf" state="restarted"
  shell: (( sleep 5; nohup service pf restart 1>/dev/null 2>&1 ) & )
  async: 1
  poll: 0
  when:
    - pf_enable
    - not ansible_check_mode
  changed_when: pf_enable
      
- name: reload pf
# service: name="pf" state="reloaded"
  shell: (( sleep 5; nohup service pf reload 1>/dev/null 2>&1 ) & )
  async: 1
  poll: 0
  when:
    - pf_enable
    - not ansible_check_mode
  changed_when: pf_enable

# blacklistd ---------------------------------------------------------
- name: enable and start blacklistd
  service:
    name: "blacklistd"
    state: started
    enabled: yes

- name: disable and stop blacklistd
  service:
    name: "blacklistd"
    state: stopped
    enabled: no

- name: restart blacklistd
  service:
    name: "blacklistd"
    state: restarted
  when: pf_blacklistd_enable

# /etc/rc.d/blacklistd: unknown directive 'reload'.
#  - name: reload blacklistd
#  service:
#    name: "blacklistd"
#    state: reloaded
#  when: pf_blacklistd_enable

# EOF
...
